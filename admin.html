<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üîê Admin - Addon Upload</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .admin-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .form-group {
      margin-bottom: 1.2rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      background: var(--bg-primary);
      color: var(--text-primary);
      border-radius: 12px;
    }
    .btn-upload {
      background: #28a745;
      color: white;
      border: none;
      padding: 0.8rem 1.2rem;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1rem;
    }
    .btn-upload:hover {
      background: #218838;
    }
    .status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 12px;
      display: none;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      display: block;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      display: block;
    }
    .preview {
      display: flex; gap: 1rem; margin: 1rem 0; flex-wrap: wrap;
    }
    .preview img {
      width: 100px; height: 60px; object-fit: cover; border-radius: 8px;
    }
    .lock-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: var(--font);
      z-index: 9999;
    }
    .lock-overlay input {
      margin: 1rem 0;
      padding: 0.8rem;
      width: 80%;
      max-width: 300px;
      border: none;
      border-radius: 12px;
      text-align: center;
      font-size: 1.1rem;
    }
  </style>
</head>
<body class="light">
  <!-- Password Prompt Overlay -->
  <div id="lock-screen" class="lock-overlay">
    <h2>üîê Admin Access</h2>
    <p>Enter your password to continue</p>
    <input type="password" id="admin-pass" placeholder="Password" />
    <button onclick="checkPassword()" style="padding: 0.7rem 1.5rem; background: #0078d4; color: white; border: none; border-radius: 12px; cursor: pointer;">Login</button>
  </div>

  <div class="container">
    <header class="header">
      <h1>üîê Admin Dashboard</h1>
      <p>Upload and manage your addons easily</p>
      <button id="theme-toggle" class="btn-icon">üåô</button>
    </header>

    <main class="admin-container">
      <form id="addon-form">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="name" required />
        </div>

        <div class="form-group">
          <label>Type</label>
          <select id="type" required>
            <option value="free">Free</option>
            <option value="paid">Paid</option>
          </select>
        </div>

        <div class="form-group">
          <label>Version</label>
          <input type="text" id="version" value="1.0" required />
        </div>

        <div class="form-group">
          <label>Author</label>
          <input type="text" id="author" value="You" required />
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="description" rows="3" required></textarea>
        </div>

        <div class="form-group">
          <label>Icon (PNG, 280x160 recommended)</label>
          <input type="file" id="icon" accept="image/png, image/jpeg" required />
          <div class="preview" id="icon-preview"></div>
        </div>

        <div class="form-group">
          <label>Addon File (.zip)</label>
          <input type="file" id="file" accept=".zip" required />
        </div>

        <button type="submit" class="btn-upload">üì§ Upload Addon</button>
      </form>

      <div id="status" class="status"></div>
    </main>
  </div>

  <script>
    // === CONFIGURATION ===
    const GITHUB = {
      owner: "scleragames",     // ‚Üê CHANGE ME
      repo:  "SOMS-Addons-Store",          // ‚Üê CHANGE ME
      token: "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" // ‚Üê CHANGE ME (keep private!)
    };

    const ADMIN_PASSWORD = "passplease";  // ‚Üê CHANGE THIS TO YOUR PASSWORD

    // === HELPERS ===
    function utf8ToBase64(str) {
      try {
        return btoa(unescape(encodeURIComponent(str)));
      } catch (e) {
        console.error("Encoding failed:", e);
        throw new Error("Invalid characters in input (emojis/symbols may be corrupted)");
      }
    }

    function sanitize(str) {
      return str
        .replace(/[\uD800-\uDFFF]/g, '')  // Remove broken surrogate pairs
        .replace(/[^\x00-\x7F]/g, c => {
          // Normalize common Unicode punctuation
          if (['‚Äî', '‚Äì'].includes(c)) return '-';
          if (['‚Äú', '‚Äù'].includes(c)) return '"';
          if (['‚Äò', '‚Äô'].includes(c)) return "'";
          if (c === '‚ù§Ô∏è' || c === '‚ô•') return '‚ù§';
          return c; // Keep others like üåü if possible
        });
    }

    // === PASSWORD PROTECTION ===
    function checkPassword() {
      const pass = document.getElementById("admin-pass").value;
      if (pass === ADMIN_PASSWORD) {
        document.getElementById("lock-screen").style.display = "none";
        sessionStorage.setItem("loggedIn", "true");
      } else {
        alert("‚ùå Incorrect password!");
      }
    }

    if (sessionStorage.getItem("loggedIn") !== "true") {
      document.getElementById("lock-screen").style.display = "flex";
    } else {
      document.getElementById("lock-screen").style.display = "none";
    }

    // === THEME TOGGLE ===
    const themeToggle = document.getElementById("theme-toggle");
    const body = document.body;
    const savedTheme = localStorage.getItem("theme") || "light";
    body.className = savedTheme;
    themeToggle.textContent = savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";

    themeToggle.addEventListener("click", () => {
      const isDark = body.className === "dark";
      body.className = isDark ? "light" : "dark";
      localStorage.setItem("theme", isDark ? "light" : "dark");
      themeToggle.textContent = isDark ? "üåô" : "‚òÄÔ∏è";
    });

    // === ICON PREVIEW ===
    document.getElementById("icon").addEventListener("change", (e) => {
      const preview = document.getElementById("icon-preview");
      preview.innerHTML = "";
      if (e.target.files[0]) {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(e.target.files[0]);
        preview.appendChild(img);
      }
    });

    // === FORM SUBMISSION ===
    document.getElementById("addon-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const status = document.getElementById("status");
      status.className = "status";

      try {
        const name = sanitize(document.getElementById("name").value.trim());
        const type = document.getElementById("type").value;
        const version = sanitize(document.getElementById("version").value);
        const author = sanitize(document.getElementById("author").value);
        const description = sanitize(document.getElementById("description").value);
        const iconFile = document.getElementById("icon").files[0];
        const addonFile = document.getElementById("file").files[0];

        if (!name || !description || !iconFile || !addonFile) {
          throw new Error("All fields are required.");
        }

        const { owner, repo, token } = GITHUB;
        const headers = {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        };

        // Generate safe ID
        const id = name.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "");

        // === UPLOAD ICON ===
        const iconPath = `icons/${type}/${id}.png`;
        const iconData = await iconFile.arrayBuffer();
        const iconBase64 = btoa(String.fromCharCode(...new Uint8Array(iconData)));

        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${iconPath}`, {
          method: "PUT",
          headers,
          body: JSON.stringify({
            message: `Upload icon: ${name}`,
            content: iconBase64
          })
        });

        // === UPLOAD ADDON FILE (if free) ===
        let fileEntry = {};
        if (type === "free") {
          const addonPath = `addons/${type}/${id}.zip`;
          const addonData = await addonFile.arrayBuffer();
          const addonBase64 = btoa(String.fromCharCode(...new Uint8Array(addonData)));

          await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${addonPath}`, {
            method: "PUT",
            headers,
            body: JSON.stringify({
              message: `Upload addon: ${name}`,
              content: addonBase64
            })
          });
          fileEntry.file = addonPath;
        }

        // === UPDATE addons.json ===
        const jsonRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/addons.json`);
        const jsonData = await jsonRes.json();
        const currentAddons = JSON.parse(atob(jsonData.content));

        if (currentAddons.some(a => a.id === id)) {
          throw new Error(`Addon ID "${id}" already exists. Try a different name.`);
        }

        const newAddon = {
          id,
          name,
          type,
          icon: iconPath,
          description,
          version,
          author,
          ...fileEntry
        };

        currentAddons.push(newAddon);

        const updatedJson = JSON.stringify(currentAddons, null, 2);
        const jsonBase64 = utf8ToBase64(updatedJson); // ‚úÖ UTF-8 Safe

        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/addons.json`, {
          method: "PUT",
          headers,
          body: JSON.stringify({
            message: `Add new addon: ${name}`,
            content: jsonBase64,
            sha: jsonData.sha
          })
        });

        // === SUCCESS ===
        status.className = "status success";
        status.textContent = `‚úÖ Success! "${name}" has been uploaded and will appear on the store.`;

        // Reset form
        document.getElementById("addon-form").reset();
        document.getElementById("icon-preview").innerHTML = "";

      } catch (err) {
        console.error("Upload failed:", err);
        status.className = "status error";
        status.textContent = `‚ùå Error: ${err.message || "Upload failed. Check console."}`;
      }
    });
  </script>
</body>
</html>



